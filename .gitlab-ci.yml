image: mcr.microsoft.com/dotnet/sdk:10.0

stages:
  - restore
  - build
  - test
  - code_quality
  - publish

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  NUGET_PACKAGES: "$CI_PROJECT_DIR/.nuget/packages"

cache:
  paths:
    - .nuget/packages/

before_script:
  - dotnet --info

restore:
  stage: restore
  script:
    - dotnet restore src/BoilerplateWPF.sln
  artifacts:
    paths:
      - .nuget/packages/

build:
  stage: build
  script:
    - dotnet build src/BoilerplateWPF.sln -c Release --no-restore
  artifacts:
    paths:
      - src/**/bin/**
      - src/**/obj/**

test:
  stage: test
  script:
    # Run unit tests and capture XPlat coverage
    - dotnet test src/App.UnitTests/App.UnitTests.csproj --collect:"XPlat Code Coverage" --results-directory TestResults --logger "trx;LogFileName=test_results.trx" --no-build
    # Install reportgenerator and create reports (cobertura + html summary)
    - dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.1.23 || true
    - export PATH="$PATH:$HOME/.dotnet/tools"
    - reportgenerator -reports:TestResults/**/coverage.*.xml -targetdir:CoverageReport -reporttypes:HtmlSummary,Cobertura || true
  artifacts:
    when: always
    paths:
      - TestResults/
      - CoverageReport/
    reports:
      junit: TestResults/**/*.trx
      cobertura: CoverageReport/*cobertura*.xml
  coverage: '/Coverage.*?([0-9]+\.?[0-9]*)%/'

code_quality:
  stage: code_quality
  script:
    - dotnet tool install --global dotnet-format --version 7.0.255301 || true
    - export PATH="$PATH:$HOME/.dotnet/tools"
    - dotnet format --verify-no-changes --folder src || true
  allow_failure: true
  artifacts:
    when: always
    paths:
      - codequality/

publish:
  stage: publish
  script:
    - dotnet publish src/App.UI/App.UI.csproj -c Release -o publish_output --no-build
  artifacts:
    when: always
    paths:
      - publish_output/
    expire_in: 1 week
