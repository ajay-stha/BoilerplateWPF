image: mcr.microsoft.com/dotnet/sdk:10.0

workflow:
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - if: '$CI_COMMIT_BRANCH == "bajra_develop" || $CI_COMMIT_BRANCH == "bajra_main"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never

default:
  tags:
    - gos-runner

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build
  - test
  - code_quality
  - publish
  - release

build:
  stage: build
  variables:
    GIT_STRATEGY: fetch
  script:
    - dotnet restore src/BoilerplateWPF.sln
    - dotnet build src/BoilerplateWPF.sln -c $env:BUILD_CONFIGURATION --no-restore

test:
  stage: test
  needs: ["build"]
  variables:
    GIT_STRATEGY: none
  before_script:
    - dotnet new tool-manifest --force
    - dotnet tool install dotnet-reportgenerator-globaltool --version 5.4.7
    - dotnet tool restore

  script:
    - dotnet test "src/App.UnitTests/App.UnitTests.csproj" -c $env:BUILD_CONFIGURATION `
        --collect:"XPlat Code Coverage" `
        --results-directory "TestResults" `
        --logger "trx;LogFileName=test_results.trx" `
        --logger "junit;LogFileName=test_results.xml" `
        /p:CollectCoverage=true `
        /p:CoverletOutput="TestResults/coverage.opencover.xml" `
        /p:CoverletOutputFormat=opencover `
        /p:ExcludeByFile="**/*.xaml.cs" `
        /p:ExcludeByFile="**/*.xaml" `
        /p:ExcludeByFile="**/Extensions/**/*.cs" `
        /p:ExcludeByFile="**/Models/**/*.cs" `
        /p:ExcludeByFile="**/Converters/**/*.cs"

    - dotnet tool run reportgenerator `
        -reports:"TestResults/**/coverage.*.xml" `
        -targetdir:"CoverageReport" `
        -reporttypes:"Cobertura"

    - $coverageLine = (Select-String -Path "./CoverageReport/Cobertura.xml" -Pattern 'line-rate="([0-9.]+)"').Matches[0].Groups[1].Value
    - $coveragePercent = [math]::Round([double]$coverageLine * 100, 2)
    - echo "Coverage $coveragePercent%"
  artifacts:
    when: always
    paths:
      - TestResults/
      - CoverageReport/
    reports:
      junit: TestResults/**/test_results.xml
      coverage_report:
        coverage_format: cobertura
        path: CoverageReport/Cobertura.xml
  coverage: '/Coverage.*?([0-9]+\.?[0-9]*)%/'
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - script_failure
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: on_success


code_quality:
  stage: code_quality
  needs: ["build"]
  variables:
    GIT_STRATEGY: none
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: on_success
  before_script:
    - dotnet new tool-manifest --force
    - dotnet tool install JetBrains.ReSharper.GlobalTools
    - dotnet tool install resharper-to-codeclimate
    - $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

  script:
    - dir src/
    - jb inspectcode src/BoilerplateWPF.sln `
        --output=resharper-results.xml `
        --format=Xml `
        --no-build `
        --no-swea

    - resharper-to-codeclimate resharper-results.xml gl-code-quality-report.json
    
    - |
      $branch = $env:CI_COMMIT_BRANCH
      $report = Get-Content gl-code-quality-report.json | ConvertFrom-Json

      Write-Host "Processing $($report.Count) code quality issues..."
      $report | ForEach-Object {
        Write-Host "Original: $($_.location.path)"
        $_.location.path = "src/" + $_.location.path
        Write-Host "Modified: $($_.location.path)"
        $_
      } | ConvertTo-Json -Depth 100 | Set-Content gl-code-quality-report.json

      if ($branch -ne "bajra_main") {
        Write-Host "Filtering CodeQuality to changed files only..."

        $changedFiles = git diff --name-only `
          origin/$env:CI_DEFAULT_BRANCH...$env:CI_COMMIT_SHA

        $report = Get-Content gl-code-quality-report.json | ConvertFrom-Json
        $report = $report | Where-Object {
          $changedFiles -contains $_.location.path
        }

        $report | ConvertTo-Json -Depth 100 |
          Set-Content gl-code-quality-report.json
      }

      Write-Host "ISSUES FOUND: $($report.Count)"

  artifacts:
    when: always
    paths:
      - resharper-results.xml
      - gl-code-quality-report.json
    reports:
      codequality: gl-code-quality-report.json
    expire_in: 1 day

publish:
  stage: publish
  needs:
    - build
  variables:
    GIT_STRATEGY: none
  script:
    - dotnet publish src/App.UI/App.UI.csproj `
        -c $env:BUILD_CONFIGURATION `
        -o publish_output `
        --no-build
  artifacts:
    name: "App-$CI_COMMIT_TAG"
    when: always
    paths:
      - publish_output/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - when: never

create_release:
  stage: release
  needs:
    - publish
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - when: never

  script:
    - echo "Creating release for tag $CI_COMMIT_TAG"
    - Invoke-WebRequest -Uri "https://gitlab.com/gitlab-org/release-cli/-/releases/v0.24.0/downloads/bin/release-cli-windows-amd64.exe" -OutFile "release-cli.exe"
    - |
      $tag = $env:CI_COMMIT_TAG
      $sha = $env:CI_COMMIT_SHA
      $pipeline = $env:CI_PIPELINE_URL
      $jobId = $env:CI_JOB_ID
      $projectUrl = $env:CI_PROJECT_URL

      $assetsJson = @"
      [{
        "name": "App",
        "url": "$projectUrl/-/jobs/$jobId/artifacts/download",
        "link_type": "other"
      }]
      "@

      .\release-cli.exe create `
          --name "Release $tag" `
          --tag-name "$tag" `
          --description "## ðŸš€ Release $tag`n`n**Commit:** $sha`n**Pipeline:** $pipeline`n`n### Changes`n- See commit history for details" `
          --assets-link $assetsJson
