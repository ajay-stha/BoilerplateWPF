image: mcr.microsoft.com/dotnet/sdk:10.0

default:
  tags:
    - gos-runner

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  NUGET_PACKAGES: "$CI_PROJECT_DIR/.nuget/packages"
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - restore
  - build
  - test
  - code_quality
  - publish

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .nuget/packages/
    - src/**/bin/**
    - src/**/obj/**

restore:
  stage: restore
  script:
    - dotnet restore src/BoilerplateWPF.sln

build:
  stage: build
  needs: [restore]
  script:
    - dotnet build src/BoilerplateWPF.sln -c Release --no-restore

test:
  stage: test
  needs: [build]
  script:
    # Run unit tests + coverage
    - dotnet test src/App.UnitTests/App.UnitTests.csproj `
        --collect:"XPlat Code Coverage" `
        --results-directory TestResults `
        --logger "trx;LogFileName=test_results.trx" `
        --no-build

    # Install local tools for report generation
    - dotnet new tool-manifest --force
    - dotnet tool install dotnet-reportgenerator-globaltool

    # Generate coverage reports
    - dotnet tool run reportgenerator `
        -reports:"TestResults/**/coverage.*.xml" `
        -targetdir:"CoverageReport" `
        -reporttypes:"HtmlSummary;Cobertura"

  artifacts:
    when: always
    paths:
      - TestResults/
      - CoverageReport/
    reports:
      junit: TestResults/**/*.trx
      coverage_report:
        coverage_format: cobertura
        path: CoverageReport/Cobertura.xml
  coverage: '/Coverage.*?([0-9]+\.?[0-9]*)%/'

code_quality:
  stage: code_quality
  needs: [build]
  script:
    - dotnet new tool-manifest --force
    - dotnet tool install JetBrains.ReSharper.GlobalTools
    - dotnet tool install resharper-to-codeclimate
    - $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
    # Run InspectCode and output XML report
    - jb inspectcode LocatorLink.sln --output=resharper-results.xml --format=Xml --no-build --no-swea
    # Convert to CodeClimate JSON format
    - resharper-to-codeclimate resharper-results.xml gl-code-quality-report.json
    # Conditional filter on branch
    - |
      $branch = $env:CI_COMMIT_BRANCH
      Write-Host "Current branch is: $branch"
      if ($branch -eq "bajra_main") {
        Write-Host "Full CodeQuality report will be used (no filtering)."
      } else {
        Write-Host "Filtering CodeQuality report to only include changed files..."

        # Get list of changed files against default branch
        $changedFiles = git diff --name-only origin/$env:CI_DEFAULT_BRANCH...$env:CI_COMMIT_SHA

        # Read existing CodeClimate JSON report
        $report = Get-Content gl-code-quality-report.json | ConvertFrom-Json

        # Filter issues to only those whose file path is in changed files
        $filtered = $report | Where-Object { $changedFiles -contains $_.location.path }

        # Save filtered report back to JSON
        $filtered | ConvertTo-Json -Depth 100 | Set-Content gl-code-quality-report.json
      }
    # Count issues and display for GitLab UI
    - |
      Write-Host "Counting total issues..."
      $issueCount = $report.Count
      Write-Host "ISSUES FOUND: $issueCount"
  artifacts:
      when: always
      paths:
        - resharper-results.xml
        - gl-code-quality-report.json
      reports:
        codequality: gl-code-quality-report.json
      expire_in: 1 day
  allow_failure: true

publish:
  stage: publish
  needs: [build]
  script:
    - dotnet publish src/App.UI/App.UI.csproj -c Release -o publish_output --no-build
  artifacts:
    when: always
    paths:
      - publish_output/
    expire_in: 1 week
